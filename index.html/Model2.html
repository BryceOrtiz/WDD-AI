<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer CAM WDD Using AI</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .banner {
            background-color: silver;
            color: black;
            text-align: center;
            padding: 50px 0;
            font-size: 2em;
        }
        .image-container {
            display: flex;
            flex-wrap: wrap;
        }
        .image-container .image-item {
            margin: 5px;
            text-align: center;
        }
        .image-container canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12 banner">
                Summer CAM WDD Using AI
            </div>
        </div>
    </div>

    <main class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>Welcome to the Summer CAM WDD Using AI</h1>
                <p>This is the main content area. You can add more information about the event, schedule, speakers, and other details here.</p>
                <!-- Adding 20 divs with unique IDs -->
                <div id="div1">
                    <h2>Section 1. What is a convolutional neural network?</h2>
                    <ul>
                        <li>It tries to find an edge or pattern in an image.</li>
                        <li>It usually consists of one or more convolution plus pooling layer, and one fully connected (FC) layer.</li>
                        <li>When doing convolution on an image, we use a 5x5 filter. Further, we may apply several such filters to detect edge/pattern along several lines.</li>
                        <li>The cost function will be.</li>
                        <li>The last layer is output layer where we use a so-called Sigmoid activation, so that several outputs can be used.
                            <br><img src="convolutionExample3.jpg" alt="Convolution Example" width="600" height="300">
                        </li>
                    </ul>
                </div>
                <div id="div2">
                    <h2>Section 2. Load TensorFlow for JavaScript libraries</h2>
                    <p>We will use TensorFlow.js to train the model.</p>
                    <p>Click the 'Run' button below to import two JavaScript libraries.</p>
                    <p>import <a href="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js">https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js</a> for defining and training models.</p>
                    <p>import <a href="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.0.2/dist/tfjs-vis.umd.min.js">https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.0.2/dist/tfjs-vis.umd.min.js</a> for web browser visualization.</p>
                    <button id="runButton" class="btn btn-primary">Run</button>
                </div>
                <div id="div3">Console output will be displayed here.</div>
                <div id="div4">
                    <h2>Section 3. The dataset of images</h2>
                    <p>We will use a dataset from Google, <a href="https://storage.googleapis.com/learnjs-data/model-builder/mnist_images.png">https://storage.googleapis.com/learnjs-data/model-builder/mnist_images.png</a>, and their labels, <a href="https://storage.googleapis.com/learnjs-data/model-builder/mnist_labels_uint8">https://storage.googleapis.com/learnjs-data/model-builder/mnist_labels_uint8</a>.</p>
                    <p>The dataset is a big image file. It contains 65,000 images, each of size 28 x 28 x 1. The label file contains 65,000 labels. Each image uses 10 numbers to indicate which digit the image represents.</p>
                </div>
                <div id="div5">
                    <h2>Section 4. The JavaScript module to process the dataset</h2>
                    <p>We will use a JavaScript class from './data.js' to process the dataset.</p>
                    <button id="loadDatasetButton" class="btn btn-primary">Load the dataset</button>
                </div>
                <div id="div6">Lengths of trainImages and trainLabels will be displayed here.</div>
                <div id="div7">
                    <h2>Section 5. We will show 20 images from the dataset</h2>
                    <button id="showImagesButton" class="btn btn-primary">Show the first 20 images</button>
                    <div class="image-container" id="imageContainer"></div>
                </div>
                <div id="div8">
                    <h2>Section 6. Define a CNN.</h2>
                    <p>Our CNN has input of shape 28 x 28 x 1.</p>
                    <p>The first layer is a convolution + pooling. We will use 8 filters, each filter has kernel size=5 x 5 and stride =1. The activation function is ‘relu’. We use the max pooling of size 2 x 2 with stride=[2,2].</p>
                    <p>The second layer is also a convolution + pooling. This time, we use 16 filters each of kernel size=5x5 and stride =1. The activation function is also ‘relu’. We use the max pooling of size 2 x 2 with stride=[2,2].</p>
                    <p>The third layer is a fully connected layer with shape * x 1.</p>
                    <p>The last layer is the output layer, with 10 outputs representing 10 digits. The activation function is now ‘softmax’.</p>
                    <button id="defineModelButton" class="btn btn-primary">Define the model</button>
                </div>
                <div id="div9">Console output will be displayed here.</div>
                <div id="div10">
                    <h2>Section 7. Train the model using 5000 images</h2>
                    <p>The batch size = 512, and epochs = 10</p>
                    <p>The test size = 1000</p>
                    <p>The callbacks have name='Model Training', tab='Model', styles='{height: 400px}', metrics={'loss', 'acc'}</p>
                    <button id="trainModelButton" class="btn btn-primary">Train the model</button>
                </div>
                <div id="div11">Content for div11</div>
                <div id="div12">
                    <h2>Section 8. Evaluate the model</h2>
                    <p>We will obtain 500 images from the dataset mnistData.</p>
                    <p>We use the trained model to calculate the predictions and then compare the predictions with the provided labels.</p>
                    <p>We then draw a confusion matrix to show for each digit, how many images are labeled for that digit and how many images that predicted to that digit. Further, how many difference.</p>
                    <button id="showConfusionMatrixButton" class="btn btn-primary">Show a confusion matrix</button>
                </div>
                <div id="div13">Content for div13</div>
                <div id="div14">Content for div14</div>

            </div>
        </div>
    </main>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let mnistData;
        let globalModel; // Global variable to store the model

        document.getElementById('runButton').addEventListener('click', function() {
            const script1 = document.createElement('script');
            script1.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js';
            script1.onload = () => {
                console.log('TensorFlow.js library loaded.');
                document.getElementById('div3').innerText += 'TensorFlow.js library loaded.\n';
            };

            const script2 = document.createElement('script');
            script2.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.0.2/dist/tfjs-vis.umd.min.js';
            script2.onload = () => {
                console.log('TensorFlow.js visualization library loaded.');
                document.getElementById('div3').innerText += 'TensorFlow.js visualization library loaded.\n';
            };

            document.head.appendChild(script1);
            document.head.appendChild(script2);
        });

        document.getElementById('loadDatasetButton').addEventListener('click', async function() {
            const script = document.createElement('script');
            script.src = './data.js';
            script.onload = async () => {
                console.log('Data.js module loaded.');
                mnistData = new MnistData();
                await mnistData.load();
                document.getElementById('div6').innerText = `trainImages length: ${mnistData.trainImages.length}, trainLabels length: ${mnistData.trainLabels.length}`;
            };
            document.head.appendChild(script);
        });

        document.getElementById('showImagesButton').addEventListener('click', function() {
            const imageContainer = document.getElementById('imageContainer');
            imageContainer.innerHTML = ''; // Clear previous images

            const numImages = 20;
            const imageSize = 28;
            const canvasSize = 56; // Double the size for better visibility

            for (let i = 0; i < numImages; i++) {
                const canvas = document.createElement('canvas');
                canvas.width = canvasSize;
                canvas.height = canvasSize;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.createImageData(imageSize, imageSize);

                const image = mnistData.trainImages.slice(i * imageSize * imageSize, (i + 1) * imageSize * imageSize);
                for (let j = 0; j < image.length; j++) {
                    const pixel = image[j] * 255;
                    imageData.data[j * 4] = pixel; // Red
                    imageData.data[j * 4 + 1] = pixel; // Green
                    imageData.data[j * 4 + 2] = pixel; // Blue
                    imageData.data[j * 4 + 3] = 255; // Alpha
                }

                ctx.putImageData(imageData, 0, 0);
                ctx.scale(2, 2); // Scale the image for better visibility
                ctx.drawImage(canvas, 0, 0);

                const label = mnistData.trainLabels.slice(i * 10, (i + 1) * 10);
                const labelDiv = document.createElement('div');
                labelDiv.textContent = `Label: ${label}`;

                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.appendChild(canvas);
                imageItem.appendChild(labelDiv);

                imageContainer.appendChild(imageItem);
            }
        });

        document.getElementById('defineModelButton').addEventListener('click', function() {
            globalModel = tf.sequential(); // Save the model to the global variable

            globalModel.add(tf.layers.conv2d({
                inputShape: [28, 28, 1],
                kernelSize: 5,
                filters: 8,
                strides: 1,
                activation: 'relu',
                kernelInitializer: 'varianceScaling'
            }));

            globalModel.add(tf.layers.maxPooling2d({
                poolSize: [2, 2],
                strides: [2, 2]
            }));

            globalModel.add(tf.layers.conv2d({
                kernelSize: 5,
                filters: 16,
                strides: 1,
                activation: 'relu',
                kernelInitializer: 'varianceScaling'
            }));

            globalModel.add(tf.layers.maxPooling2d({
                poolSize: [2, 2],
                strides: [2, 2]
            }));

            globalModel.add(tf.layers.flatten());

            globalModel.add(tf.layers.dense({
                units: 10,
                kernelInitializer: 'varianceScaling',
                activation: 'softmax'
            }));

            // Compile the model
            globalModel.compile({
                optimizer: 'adam',
                loss: 'categoricalCrossentropy',
                metrics: ['accuracy']
            });

           // console.log('Model defined and compiled:', globalModel);
           // document.getElementById('div9').innerText = 'Model defined and compiled. Check the console for details.';

            // Use tfjs-vis to display the model summary
           // const surface = { name: 'Model Summary', tab: 'Model Inspection' };
            const surface = document.getElementById('div9');
            tfvis.show.modelSummary(surface, globalModel);
        });

        document.getElementById('trainModelButton').addEventListener('click', async function() {
            // Compile the model
            globalModel.compile({
                optimizer: 'adam',
                loss: 'categoricalCrossentropy',
                metrics: ['accuracy']
            });

            const BATCH_SIZE = 512;
            const EPOCHS = 10;
            const TRAIN_SIZE = 5000;
            const TEST_SIZE = 1000;

            const [trainXs, trainYs] = tf.tidy(() => {
                const trainData = mnistData.nextTrainBatch(TRAIN_SIZE);
                return [
                    trainData.xs.reshape([TRAIN_SIZE, 28, 28, 1]),
                    trainData.labels
                ];
            });

            const [testXs, testYs] = tf.tidy(() => {
                const testData = mnistData.nextTestBatch(TEST_SIZE);
                return [
                    testData.xs.reshape([TEST_SIZE, 28, 28, 1]),
                    testData.labels
                ];
            });

            const metrics = ['loss', 'acc'];
            /*
            const container = {
                name: 'Model Training',
                tab: 'Model',
                styles: { height: '400px' }
            };
            */

           const container = document.getElementById('div11');

            const fitCallbacks = tfvis.show.fitCallbacks(container, metrics);

            await globalModel.fit(trainXs, trainYs, {
                batchSize: BATCH_SIZE,
                epochs: EPOCHS,
                validationData: [testXs, testYs],
                callbacks: fitCallbacks
            });

            trainXs.dispose();
            trainYs.dispose();
            testXs.dispose();
            testYs.dispose();
        });

        document.getElementById('showConfusionMatrixButton').addEventListener('click', async function() {
            const TEST_SIZE = 500;

            const [testXs, testYs] = tf.tidy(() => {
                const testData = mnistData.nextTestBatch(TEST_SIZE);
                return [
                    testData.xs.reshape([TEST_SIZE, 28, 28, 1]),
                    testData.labels
                ];
            });

            const predictions = globalModel.predict(testXs).argMax(-1);
            const labels = testYs.argMax(-1);

            const classAccuracy = await tfvis.metrics.perClassAccuracy(labels, predictions);
            const confusionMatrix = await tfvis.metrics.confusionMatrix(labels, predictions);

            //const container1 = { name: 'Per Class Accuracy', tab: 'Evaluation' };
            const container1 = document.getElementById('div13');
            tfvis.show.perClassAccuracy(container1, classAccuracy);

            //const container2 = { name: 'Confusion Matrix', tab: 'Evaluation' };
            const container2 = document.getElementById('div14');
            tfvis.render.confusionMatrix(container2, {
                values: confusionMatrix,
                tickLabels: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
            });

            testXs.dispose();
            testYs.dispose();
        });
    </script>
</body>
</html>